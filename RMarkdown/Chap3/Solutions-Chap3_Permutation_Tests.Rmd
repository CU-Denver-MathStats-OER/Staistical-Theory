---
title: "Solutions Chap 3 Permutation Test"
output: 
  pdf_document: 
    fig_height: 3
    fig_width: 4
---

# Chapter 3: Permutation Tests

**Load required packages first**
```{r, message=FALSE}
library(resampledata)
```

## Permutation Test for a Difference in Two Means
### Who eats more hotwings?

The dataset **Beerwings** contains observations from a sample of 30 people at a bar in which three variables were collect: Gender, Beer and Hot Wings. Imagine a researcher wants to perform a hypothesis test to determine whether males eat more hot wings than women.

a. Write out the null and alternative hypotheses using appropriate notation.

H~0~: There is no difference in the amount of wings males and females eat. $\mu_{m} - \mu_{f} =0$

H~a~: Males eat more hotwings than females. $\mu_{m} - \mu_{f} >0$

b. What can we use as the test statistic? What is the value of the observed test statistic?

```{r}
# tapply is a really nice function
# it applies a function (in this case mean)
# to the array hotwings
# separately for each gender 

tapply(Beerwings$Hotwings, Beerwings$Gender, mean)
```

Using the output from tapply we see the males ate an average of 14.533 wings compared to the females in the sample who ate an average of 9.333 wings. We save the observed difference to array **observed** below.

```{r}
observed <- 14.533-9.333
observed
```

c. Create a permutation distribution for the difference in sample means.

```{r}
# First we create an array with 
# all hotwing totals pooled together
hotwings <- subset(Beerwings, select = Hotwings, drop = T)

# We will save all 99,999 permutation resamples statistics
# to the array named result
N <- 10^5 - 1
result <- numeric(N)

# Index contains the location (in the array)
# of the 15 random values selected for sample 1
# the other 15 non-selected locations are -index
# result = mean of resample 1 - mean of rest of values

for (i in 1:N)
{
  index <- sample(30, size = 15, replace = FALSE)
  result[i] <- mean(hotwings[index]) - mean(hotwings[-index])
}

# Permutation Distribution with 
# Observed difference in red

hist(result, xlab = "xbar1-xbar2",
     main = "Permutation Distribution")
abline(v = observed, col = "red")
```


d. Calculate the P-value. How likely is it to get samples with a difference in means as or more extreme than the observed test?

```{r}
# Note the formula below is one option
sum(result >= observed)/N

# But to be sure we count the original sample
# We add the original sample in with 
# the other 99,999 we createded
# So we add one to the count on top and bottom.
p.value <- (sum(result >= observed) + 1)/(N+1)
p.value
```

e. Interpret the meaning of the P-value.

There is a `r round(p.value*100,3)`% chance we would observe a difference in sample means as or more extreme than `r round(observed, 2)` hotwings if there really is no difference in the amount of hotwings consumed by ll males compared to all females (in entire the population).


## Permutation Test for a Difference in Variances
### Comparing the spread (variance) of flight lengths in May and June.
**(Exercise 3.9)** Using the dataset **FlightDelays**, perform a permutation test to see if the variance of the flight lengths in May is different from the variance of the flight lengths in June?

a. Write out the null and alternative hypotheses using appropriate notation.

H~0~: There is no difference in the variance of flight lengths in May and June. $\sigma^2_{m} - \sigma^2_{j} =0$

H~a~: There is no difference in the variance of flight lengths in May and June. $\sigma^2_{m} - \sigma^2_{j} \ne0$

b. What can we use as the test statistic? What is the value of the observed test statistic?

```{r}
tapply(FlightDelays$FlightLength, FlightDelays$Month, var)
```

Using the output from tapply we see the sample variance in May is 1808.357 compared to the sample variance of the flight lengths in June which is 1684.43. We save the observed difference (May-June) to **observed**.

```{r}
observed <- 1808.357-1684.43
observed
```

c. Create a permutation distribution for the difference in sample variances. 


```{r}
# The output of this code will tell us 
# how many observations in each month's sample
table(FlightDelays$Month)
```

From the code above, we see the first sample in our difference should contain $m=1999$ observations while the other sample contains the remaining $n=2030$ observations, and in total there are 4029 observations in the pooled sample.

```{r}
# Create pooled array of all flight lengths
flight.length <- subset(FlightDelays, select = FlightLength, drop = T)

# Save resamples to array result
N <- 10^5 - 1
result <- numeric(N)

# Create permutation distribution
for (i in 1:N)
{
  index <- sample(4029, size = 1999, replace = FALSE)
  result[i] <- var(flight.length[index]) - var(flight.length[-index])
}

# Display permutation distribution and observeed sample diff
hist(result, xlab = "diff in sample variances",
     main = "Permutation Distribution")
abline(v = c(-observed, observed), col = c("blue", "red"))
```

A permutation distribution is approximated by the histogram above, and the observed test statistic is indicated by the red vertical line. The blue vertical line is used to indicate how many samples are as or more extreme than the observed difference the same distance away in the left tail.

d. Calculate the P-value. How likely is it to get samples with a difference in means as or more extreme than the observed test?

Since the permutation distribution is symmetric, we can approximate the P-value as follows:

```{r}
2*(sum(result >= observed) + 1)/(N+1)
```

Note if instead we decided to double the area in the left tail, then we cou

```{r}
2*(sum(result <= -observed) + 1)/(N+1)
```

Or we could add the number of samples in each tail separately:

```{r}
(sum(result <= -observed) + 1)/(N+1) + (sum(result >= observed) + 1)/(N+1)
```

**Notice the three calculations above are not exactly equal to each other, but they are very, very close**. The distribution above is an approximation for the complete permutation distribution since we did not generate every possible permutation resample exactly once. The P-values above are based on simulations, so they give us approximations for the P-value. With this in mind, using any of the methods above is fine.


## Permutation Test for a Difference in Proportions
### Comparing the proportion of flights delayed over 20 minutes in each month.

Is the proportion of times the flights in May were delayed more than 20 minutes different from the proportion of times the flights in June were delayed more than 20 minutes? 

a. Write out the null and alternative hypotheses using appropriate notation.

H~0~: There is no difference in the proportion of flights delayed over 20 minutes in May compared to June. $p_{m} - p_{j} =0$

H~a~: There is no difference in the proportion of flights delayed over 20 minutes in May compared to June. $p_{m} - p_{j} \ne 0$

*Note the order of the difference, $p_m - p_j$ or $p_j-p_m$ is not important as long as we are consistent throughout.*


b.What can we use as the test statistic? What is the value of the observed test statistic?

+ There is no qualitative variable that explicitly indicates whether or not a flight is delayed for more than 20 minutes.
+ Instead, there is a quantitative variable called **Delay** that gives the number of minutes that a flight was delayed. 
+ So first we need to calculate the observed proportions of flights delayed over 20 minutes in each month.

The R code below creates vector that contains the pooled sample. All $m+n=4029$ flight delay times are stored in the array **Delay**. There is no viewable output.

```{r}
Delay <- FlightDelays$Delay
```

Below we create an array **Delay.May** that contains the flight delay times of all flights in May. Then we compute the proportion of values in Delay.May that are greater than 20. This proportion is displayed below.

```{r}
Delay.May <- subset(FlightDelays, select = Delay,
                    Month == "May", drop = T)
mean(Delay.May > 20)
```

+ The command **Delay.May > 20** is an logical test whose output is either true (assigned a value of 1) or false (which is assigned a value of 0). 
+ The function mean() does the typical thing. Add up all the values (0's and 1's) and divide by the total number of values in the array.
+ If we consider a much smaller Delay.May array, the calculation goes as follows:

$$
\mbox{Delay.May}=\left( \begin{array}{c} 100\\ -10 \\ 8.5 \\ 20 \\ 20.3 \end{array} \right) \ \ \mbox{gives} \ \ \mbox{Delay.May > 20}=\left( \begin{array}{c} 1\\ 0 \\ 0 \\ 0 \\ 1 \end{array} \right) \\
\\
 \mbox{so we have} \ \mbox{mean(Delay.May >20)}=\frac{2}{5}=0.4
$$

Thus the command **mean(Delay.May > 20)** is equivalent to computing the proportion of flights in May that were delayed over 20 minutes. Similarly for June we have,  

```{r}
Delay.June <- subset(FlightDelays, select = Delay,
                    Month == "June", drop = T)
mean(Delay.June > 20)

# The observed difference in two proportions
observed <- mean(Delay.May > 20) - mean(Delay.June > 20)
```

So from the code above we have the observed difference in sample proportions is $\hat{p}_m - \hat{p}_j=$ `r mean(Delay.May > 20)` - `r mean(Delay.June > 20)` = `r mean(Delay.May > 20)-mean(Delay.June > 20)`.


c. Create a permutation distribution for the difference in sample variances.


```{r}
N <- 10^5 - 1
result <- numeric(N)

for (i in 1:N)
{
  index <- sample(4029, size = 1999, replace = FALSE)
  result[i] <- mean(Delay[index]>20) - mean(Delay[-index]>20)
}

hist(result, xlab = "phat1-phat2",
     main = "Permutation Distribution")
abline(v = c(observed,-observed), col = c("red","blue"))
```

A permutation distribution is approximated by the histogram above, and the observed test statistic is indicated by the red vertical line and the blue line indicates cutoff for similarly extreme samples in right tail. 

d. Calculate the P-value. How likely is it to get samples with a difference in means as or more extreme than the observed test?

```{r}
p.value <- 2*(sum(result <= observed) + 1)/(N+1)
p.value
```

e. Interpret the meaning of the P-value.

There is a `r p.value*100`% chance we would observe a difference in sample proportions as or more extreme than `r round(observed, 4)` if there really is no difference in the proportion of all flights in May delayed over 20 minutes compared to all flights in June delayed over 20 minutes.

## Permutation Test with Match-Pairs 
### Case Study: Olympic Swimsuit

In the 2008 Olympics there was a lot of controversy over new swimsuits that possibly provided an unfair advantage to swimmers
which led to new international rules regarding swimsuit materials and coverage. Can a swimsuit really make a swimmer faster?

a. If researchers are testing to see whether the wetsuit makes people swim faster, set up hypotheses for this test.

H~0~: The wetsuit does not make a difference in how fast people are able to swim. $\mu_{\rm diff} = 0$

H~a~: The wetsuit does help people swim faster. $\mu_{\rm diff} > 0$

b. What is the observed test statistic?

```{r}
# Vectors containing the times of each swimmer. Ordering is critical
wetsuit <- c(1.57, 1.47, 1.42, 1.35, 1.22, 1.75, 1.64, 1.57, 1.56, 1.53, 1.49, 1.51)
none <- c(1.49, 1.37, 1.35, 1.27, 1.12, 1.64, 1.59, 1.52, 1.50, 1.45, 1.44, 1.41)

# Create a vector of the 12 paired differences
Diff <- wetsuit - none

# Calculate the observed test statistic, the mean of the paired differences
observed <-mean(Diff) 
observed
```

c. Create a permutation distribution for the difference in sample means.

```{r}
# Create a numeric vector size N to store the resampled paird differences
N <- 10^5-1
result <-numeric(N)

# For each pair, randomly assign the difference to be positive or negative.
# Then calculate the new mean of the paired differences
for (i in 1:N)
{
  Sign <-sample(c(-1,1), 12, replace=TRUE) # random pick -1 or 1, 12 different times (1, -1, 1,1, -1 ...)
  Diff2 <- Sign*Diff
  result[i] <- mean(Diff2)
}

# Create a histogram of the permutation distribution
# And add a vertical line at the observed test statistic
hist(result,  xlab = "xbar-diff",
     main = "Permutation Distribution")
abline(v = observed, col = "steelblue")
```

d. Calculate the P-value.

```{r}
pvalue <- (sum(result >= observed) + 1)/(N+1)
pvalue
```

e. Interpret the meaning of the P-value.

There is a `r pvalue*100` % chance of observing a sample difference of `r observed` if the wetsuit does not help people swim faster.

### Case Study: Comparing Prices at Target and Walmart

(Exercise 3.15) Is there a difference in the price of groceries sold by Target and Walmart? The dataset **Groceries** contains a sample of grocery items and their prices advertised on their respective websites on a specific day.

a. Set up hypotheses for this test.

H~0~: There is no difference in the prices charged at Target and Walmart. $\mu_{\rm diff} = 0$

H~a~: There is a difference in the prices charged at Target and Walmart. $\mu_{\rm diff} \ne 0$

b. What is the observed test statistic?

```{r}
target <-Groceries$Target
walmart <-Groceries$Walmart

diff <- target - walmart
n.pairs <- length(diff)

observed.diff <- mean(diff)
observed.diff
```

c. Create a permutation distribution for the difference in sample means.

```{r}
# Create a numeric vector size N to store the resampled paird differences
N <- 10^5-1
result <-numeric(N)

# For each pair, randomly assign the difference to be positive or negative.
# Then calculate the new mean of the paired differences
for (i in 1:N)
{
  Sign <-sample(c(-1,1), n.pairs, replace=TRUE) # random pick -1 or 1, 12 different times (1, -1, 1,1, -1 ...)
  diff.signed <- Sign*diff
  result[i] <- mean(diff.signed)
}

# Create a histogram of the permutation distribution
# And add a vertical line at the observed test statistic
hist(result,  xlab = "xbar-diff",
     main = "Permutation Distribution")
abline(v = observed.diff, col = "steelblue")
```

d. Calculate the P-value.

```{r}
# doubling the area in left tail
pvalue.left <- 2*(sum(result <= -1*abs(observed.diff))+1)/(N+1)

# doubling the area in right tail
pvalue.right <- 2*(sum(result >= abs(observed.diff))+1)/(N+1)

# Adding areas in each tail separately
pvalue.both <- (sum(result <= -1*abs(observed.diff))+1)/(N+1) + (sum(result >= abs(observed.diff))+1)/(N+1)

pvalue.left
pvalue.right
pvalue.both
```

e. Interpret the meaning of the P-value.

There is a `r pvalue.right*100` % chance of observing a sample difference of `r observed.diff` if there was no difference in prices charged at Target and Walmart.
---
output:
  html_document: default
---
<!--```{r setup, include = FALSE}
knitr::opts_chunk$set(eval = FALSE)
``` -->

# Exercises for Worksheet 10: Permutation Tests
### Mar 8, 2021

**Load required packages first**
```{r, message=FALSE}
library(resampledata)
```

## Permutation Test for a Difference in Two Means
### Who eats more hotwings?

1. **The dataset <font color="green">*Beerwings*</font> contains observations from a sample of 30 people at a bar in which three variables were collect: Gender, Beer and Hot Wings. Imagine a researcher wants to perform a hypothesis test to determine whether males eat more hot wings than women.** 

a. **Write out the null and alternative hypotheses using appropriate notation.**

H~0~: There is no difference in the amount of wings males and females eat. $\mu_{m} - \mu_{f} =0$

H~a~: Males eat more hotwings than females. $\mu_{m} - \mu_{f} >0$


b. **What can we use as the test statistic? What is the value of the observed test statistic?** 

```{r}
tapply(Beerwings$Hotwings, Beerwings$Gender, mean)
```

Using the output from tapply we see the males ate an average of 14.533 wings compared to the females in the sample who ate an average of 9.333 wings. We save the observed difference to <font color="red">observed</font>.

```{r}
observed <- 14.533-9.333
print(observed)
```

c. **Create a permutation distribution for the difference in sample means.**

+ We have one sample already, that is the actual difference we saved to <font color="red">observed</font>.
+ Let's generate $N=10^5-1$ more resamples and calculate the difference in the means for each resample.

```{r}
hotwings <- subset(Beerwings, select = Hotwings, drop = T)

N <- 10^5 - 1
result <- numeric(N)

for (i in 1:N)
{
  index <- sample(30, size = 15, replace = FALSE)
  result[i] <- mean(hotwings[index]) - mean(hotwings[-index])
}

hist(result, xlab = "xbar1-xbar2",
     main = "Permutation Distribution")
abline(v = observed, col = "red")
```

A permutation distribution is approximated by the histogram above, and the observed test statistic is indicated by the red vertical line.

d. **Calculate the P-value. How likely is it to get samples with a difference in means as or more extreme than the observed test?**

```{r}
(sum(result >= observed) + 1)/(N+1)
```

+ **<font color="red">result >= observed</font>** is a true/false operator. 
+ If a permutation resample has a difference greater than or equal to observed, the expression is TRUE and the output is the number 1.
+ If a permutation resample has a difference less than observed, the expression is FALSE and the output is the number 0.
+ All the 0's and 1's are added together, plus a additional 1 for the observed difference in sample means in our original sample.
+ Then we divide by the number of permutation resamples, $N$, plus an additional 1 for the original sample.
+ This gives the total number of samples as or more extreme than the observed sample, divided by the total number of samples in the permutation distribution.
+ We get an approximate **<font color="green">P-value $=$ `r round((sum(result >= observed) + 1)/(N+1), 6)`</font>**.


e. **Interpret the meaning of the P-value.**

There is a `r (sum(result >= observed) + 1)/(N+1)*100`% chance we would observe a difference in sample means as or more extreme than `r round(observed, 2)` hotwings if there really is no difference in the amount of hotwings consumed by ll males compared to all females (in entire the population).

## Permutation Test for a Difference in Variances
### Comparing the spread (variance) of flight lengths in May and June.

2. (Exercise 3.9) **Using the dataset FlightDelays, perform a permutation test to see if the variance of the flight lengths in May is different from the variance of the flight lengths in June?**

a. **Write out the null and alternative hypotheses using appropriate notation.**

H~0~: There is no difference in the variance of flight lengths in May and June. $\sigma^2_{m} - \sigma^2_{j} =0$

H~a~: There is no difference in the variance of flight lengths in May and June. $\sigma^2_{m} - \sigma^2_{j} \ne0$

b. **What can we use as the test statistic? What is the value of the observed test statistic?** 

```{r}
tapply(FlightDelays$FlightLength, FlightDelays$Month, var)
```

Using the output from tapply we see the sample variance in May is 1808.357 compared to the sample variance of the flight lengths in June which is 1684.43. We save the observed difference (May-June) to <font color="red">observed</font>.

```{r}
observed <- 1808.357-1684.43
print(observed)
```

c. **Create a permutation distribution for the difference in sample variances.**

+ We have one sample already, that is the actual difference we saved to <font color="red">observed</font>.
+ Let's generate $N=10^5-1$ more resamples and calculate the difference in the variances for each resample.
+ Since we used the test statistic $s^2_m-s^2_j$, our first sample should contain the same number of observations as the number of flights in May in our original dataset. 

```{r}
table(FlightDelays$Month)
```

From the code above, we see the first sample in our difference should contain $m=1999$ observations while the other sample contains the remaining $n=2030$ observations.

```{r}
length <- subset(FlightDelays, select = FlightLength, drop = TRUE)

N <- 10^5 - 1
result <- numeric(N)

for (i in 1:N)
{
  index <- sample(4029, size = 1999, replace = FALSE)
  result[i] <- var(length[index]) - var(length[-index])
}

hist(result, xlab = "diff in sample variances",
     main = "Permutation Distribution")
abline(v = c(-observed, observed), col = c("blue", "red"))
```

A permutation distribution is approximated by the histogram above, and the observed test statistic is indicated by the red vertical line. The blue vertical line is used to indicate how many samples are as or more extreme than the observed difference the same distance away in the left tail.

d. **Calculate the P-value. How likely is it to get samples with a difference in means as or more extreme than the observed test?**

Since the permutation distribution is symmetric, we can approximate the P-value as follows:

```{r}
2*(sum(result >= observed) + 1)/(N+1)
```

Note if instead we decided to double the area in the left tail, then we could compute:

```{r}
2*(sum(result <= -observed) + 1)/(N+1)
```

Or we could add the number of samples in each tail separately:

```{r}
(sum(result <= -observed) + 1)/(N+1) + (sum(result >= observed) + 1)/(N+1)
```

**<font color="green">Notice the three calculations above are not exactly equal to each other, but they are very, very close</font>**. The distribution above is an approximation for the complete permutation distribution since we did not generate every possible permutation resample exactly once. The P-values above are based on simulations, so they give us approximations for the P-value. With this in mind, using any of the methods above is fine.

## Permutation Test for a Difference in Proportions
### Comparing the proportion of flights delayed over 20 minutes in each month.

3. **Is the proportion of times the flights in May were delayed more than 20 minutes different from the proportion of times the flights in June were delayed more than 20 minutes?** 

a. **Write out the null and alternative hypotheses using appropriate notation.**

H~0~: There is no difference in the proportion of flights delayed over 20 minutes in May compared to June. $p_{m} - p_{j} =0$

H~a~: There is no difference in the proportion of flights delayed over 20 minutes in May compared to June. $p_{m} - p_{j} \ne 0$

*Note the order of the difference, $p_m - p_j$ or $p_j-p_m$ is not important as long as we are consistent throughout.*

b.**What can we use as the test statistic? What is the value of the observed test statistic?**

+ There is no qualitative variable that explicitly indicates whether or not a flight is delayed for more than 20 minutes.
+ Instead, there is a quantitative variable called <font color="green">Delay</font> that gives the number of minutes that a flight was delayed. 
+ So first we need to calculate the observed proportions of flights delayed over 20 minutes in each month.

The R code below creates vector that contains the pooled sample. All $m+n=4029$ flight delay times are stored in the vector <font color="green">Delay</font>. There is no viewable output.

```{r}
Delay <- FlightDelays$Delay
```

Below we create a vector <font color="green">Delay.May</font> that contains the flight delay times of all flights in May. Then we compute the proportion of values in Delay.May that are greater than 20. This proportion is displayed below.

```{r}
Delay.May <- subset(FlightDelays, select = Delay,
                    Month == "May", drop = T)
mean(Delay.May > 20)
```

+ The command <font color="red">**Delay.May > 20**</font> is an operation whose output is either true (assigned a value of 1) or false (which is assigned a value of 0). 
+ The function mean() does the typical thing. Add up all the values (0's and 1's) and divide by the total number of values in the vector.
+ If we consider a much smaller Delay.May vector, the calculation goes as follows:

<font color="green">
$$
\mbox{Delay.May}=\left( \begin{array}{c} 100\\ -10 \\ 8.5 \\ 20 \\ 20.3 \end{array} \right) \ \ \mbox{gives} \ \ \mbox{Delay.May > 20}=\left( \begin{array}{c} 1\\ 0 \\ 0 \\ 0 \\ 1 \end{array} \right) \\
\\
 \mbox{so we have} \ \mbox{mean(Delay.May >20)}=\frac{2}{5}=0.4
$$
</font>

Thus the command <font color="red">**mean(Delay.May > 20)**</font> is equivalent to computing the proportion of flights in May that were delayed over 20 minutes. Similarly for June we have,  

```{r}
Delay.June <- subset(FlightDelays, select = Delay,
                    Month == "June", drop = T)
mean(Delay.June > 20)
observed <- mean(Delay.May > 20) - mean(Delay.June > 20)
```

So from the code above we have the observed difference in sample proportions is $\hat{p}_m - \hat{p}_j=$ `r mean(Delay.May > 20)` - `r mean(Delay.June > 20)` = `r mean(Delay.May > 20)-mean(Delay.June > 20)`.


c. **Create a permutation distribution for the difference in sample variances.**

+ We have one sample already, that is the actual difference we saved to <font color="red">observed</font>.
+ Let's generate $N=10^5-1$ more resamples and calculate the difference in the variances for each resample.
+ Since we used the test statistic $\hat{p}_m - \hat{p}_j$, our first sample proportion $\hat{p}_m$ should contain the same number of observations as the number of flights in May. 
+ From the previous variance example we in our original dataset we know there are 1999 flights in May.

```{r}
N <- 10^5 - 1
result <- numeric(N)

for (i in 1:N)
{
  index <- sample(4029, size = 1999, replace = FALSE)
  result[i] <- mean(Delay[index]>20) - mean(Delay[-index]>20)
}

hist(result, xlab = "phat1-phat2",
     main = "Permutation Distribution")
abline(v = c(observed,-observed), col = c("red","blue"))
```

A permutation distribution is approximated by the histogram above, and the observed test statistic is indicated by the red vertical line and the blue line indicates cutoff for similarly extreme samples in right tail. 

d. **Calculate the P-value. How likely is it to get samples with a difference in means as or more extreme than the observed test?**

```{r}
2*(sum(result <= observed) + 1)/(N+1)
```


e. **Interpret the meaning of the P-value.**

There is a `r 2*(sum(result <= observed) + 1)/(N+1)*100`% chance we would observe a difference in sample proportions as or more extreme than `r round(observed, 4)` if there really is no difference in the proportion of all flights in May delayed over 20 minutes compared to all flights in June delayed over 20 minutes.
